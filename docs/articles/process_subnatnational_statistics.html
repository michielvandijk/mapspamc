<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Process subnational statistics • mapspamc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Process subnational statistics">
<meta property="og:description" content="mapspamc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapspamc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Background</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/crop_distribution_maps.html">Crop distribution maps</a>
        </li>
        <li>
          <a href="../articles/model_structure.html">Model structure</a>
        </li>
        <li>
          <a href="../articles/data.html">Input data</a>
        </li>
        <li>
          <a href="../articles/appendix.html">Appendix</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Preparation</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/input_data_collection.html">Input data collection</a>
        </li>
        <li>
          <a href="../articles/template.html">Download template</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Run SPAMc</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/model_setup.html">1. Model setup</a>
        </li>
        <li>
          <a href="../articles/process_subnational_statistics.html">2. Process subnational statistics</a>
        </li>
        <li>
          <a href="../articles/process_spatial_data.html">3. Process spatial data</a>
        </li>
        <li>
          <a href="../articles/create_synergy_cropland.html">4. Create synergy cropland map</a>
        </li>
        <li>
          <a href="../articles/create_synergy_ir_area.html">5. Create synergy irrigated area map</a>
        </li>
        <li>
          <a href="../articles/run_spamc.html">6. Run model</a>
        </li>
        <li>
          <a href="../articles/post_process.html">7. Post-processing</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/iiasa/mapspamc">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Process subnational statistics</h1>
            
      
      
      <div class="hidden name"><code>process_subnatnational_statistics.Rmd</code></div>

    </div>

    
    
<p>Subnational statistics on harvested area are a key input into SPAMc. Before they can be used they need to be put in the right format, made consistent and aggregated (or split) to the crops and farming systems that are used by SPAMc. Unfortunately, the level of detail (e.g. many detailed crops or a few crop groups, at the administrative level 0, 1 or 2 level), coverage (full crop and administrative unit coverage or many missing values) and quality (do lower levels of administrative unit data add up to higher levels?) of these statistics may differ enormeously between countries. Cleaning, harmonizing and preparing the subnational statistics is probably the most time consuming and difficult part of running SPAMc. In many cases the researcher has to make a value judgement on which statistics to keep and which to discard to make them consistent. Which data is more reliable if they do not add up? Administrative unit level 1 or 2? If, the harvested area for say vegetables seems exceptionally and perhaps unrealisticaly large in a certain administrative region, is this a data entry error or is it really that hight? These are decisions that often need to be taken when preparing the data if the quality is poor. Hence, there is no simple formula or function that makes it possible to (semi) automatically prepare the raw subnational statistics so that they can be used by SPAMc. It requires a lot of user input and ad hoc coding to get the data ready.</p>
<p>We prefer to break down the processing and preparation of the subnational statistics into two steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Processing of raw subnational statistics.</strong> In this step, the raw statistics, meaning the various data files that were downloaded from the national statistical office or taken from any other source, are reshaped, reaggregated and cleaned so they are nearly ready to be used by SPAMc.</li>
<li>
<strong>Checking of calibrating processed subnational statistics.</strong>: In this step, the processed statistics are checked for consistency, adjusted where needed and calibrated to the FAOSTAT national statistics.</li>
</ol>
<p>The scripts that we used how to prepare the data for Malawi offer some guidance and can be adapted where needed. They are located in the <code>02_subnational_statistics</code> folder of the template. They also illustrate the use of several functions and tools that we developed to support the process. We prefer and highly recommend to code all the steps that are needed to process statistics in R so everything is nicely documented and fully reproducible. The <a href="https://tidyr.tidyverse.org/">tidyr</a> and <a href="https://dplyr.tidyverse.org/">dplyr</a> packages offer a variety of functions that are specially designed to clean up and process ‘messy’ data.. It is also possible to use Excel or any other software to process the raw national statistics as long as the statistics are saved in the correct format so they can be used for further processing. Obviously a major disadvantage is that it will be very difficult to track changes or quickly make adjustments when new data becomes available and needs to be added.</p>
<div id="support-scripts" class="section level2">
<h2 class="hasAnchor">
<a href="#support-scripts" class="anchor"></a>Support scripts</h2>
<p>Apart from the main scripts that clean and check the statistics, which will be discussed below, the template contains three other scripts that support these processes.</p>
<ul>
<li><code>001_process_aquastat.r</code></li>
<li><code>001_calculate_irrigated_area_share.r</code></li>
<li><code>01_process_faostat_crops.r</code></li>
</ul>
<p>The first two scripts select relevant country data from the AQUASTAT database and use this to calculate the share of irrigated area per crop. This information can be used to as input to inform the irrigated area shares that are needed for the farming system shares data table (See below). We will not discuss these scripts here. Please have a look and try by yourself.</p>
<p>The third script prepares the national FAOSTAT statistics. These are used for two purposes. The first is for calibration of the subnational statistics so they are in line with FAOSTAT. As FAOSTAT is the leading source on agricultural data, it is useful to ensure that the subnational data adds up to the FAOSTAT national totals. Also, GLOBIOM is fully calibrated to FAOSTAT. For many countries the totals will already be the same or at least in the same range as subnational agricultural statistics are often the basis for construction national statistics, which in turn are used as input by FAOSTAT. However, for some countries there might be large differences. The second purpose is to determine the list of crops that is needed to prepare the subnational agricultural statistics. We will discuss this further below. Make sure to run <code>01_process_faostat_crops.r</code> before starting with preparing the subnational statistics. Do not forget to set the <code>faostat_version</code> variable in the script, which corresponds with the date you added when you downloaded the data (<code>20200303</code> in the Malawi example).</p>
</div>
<div id="processing-of-raw-subnational-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#processing-of-raw-subnational-statistics" class="anchor"></a>Processing of raw subnational statistics</h2>
<p>The <code>02_process_raw_national_statistics.r</code> file shows all the steps we took to process the raw SPAM2010 statistics, turn it into the right format and make it consistent with the shapefile with the locations of the administrative units. We highlight several key steps, that you probably also need to implement to process your country data.</p>
<div id="format-of-the-processed-statistics-files" class="section level3">
<h3 class="hasAnchor">
<a href="#format-of-the-processed-statistics-files" class="anchor"></a>Format of the processed statistics files</h3>
<p>You need to create three files with subnational statistical information that will be combined later:</p>
<ol style="list-style-type: decimal">
<li>A file with <strong>Harvest area statistics (ha)</strong> in hectares for all subnational administrative unit at each level.</li>
<li>A file with <strong>Farming system shares (fs)</strong> (not percentages!) for each subnational administrative unit at the national level. If the model is solved at the subnational level 1 (by setting the model level to 1), also farming system share data need to be provided for that level.</li>
<li>A file with the <strong>Cropping intensity (ci)</strong> for each subnational administrative unit at the national and subnational 1 (similar to the farming system shares).</li>
</ol>
<p>All Crop statistics need to be stored using in the <strong>wide</strong> format. With this we mean that the first three or four columns of the data table list the administrative unit code (<code>adm_code</code>), name (<code>adm_name</code>), level (<code>adm_level</code>) and potentially the farming system (<code>system</code>) in case of farming system shares or cropping intensity data, followed by named columns, one for each crop, with harvested area, farming system shares or cropping intensity per subnational unit. <code>adm_name</code> and <code>adm_code</code> must be provided up to the most detailed administrative unit for which data is available. Hence, in case level 2 data is available, data should be supplied for level 0, 1 and 2. In case only level 1 data is available, data should be supplied for level 0 and level 1.</p>
<p><code><a href="../reference/create_statistics_template.html">create_statistics_template()</a></code> will create templates for the ha, fs and ci data files - also see the Malawi ha, fs and ci files for examples. The number and depth of the administrative units will be determined by the model parameters stored in the <code>spamc_par</code> object as well as the <code>adm_list</code> file that is created with <code><a href="../reference/create_adm_list.html">create_adm_list()</a></code>. By defauls, the template will have columns for all 40 SPAMc crops.</p>
<p>You can save the template as csv file and use it as a basis to prepare the statistics. Note that is is essential that you follow the template closely! Adding or removing administrative units will result in errors as the data no longer matches with the map that contains the location of the administrative units. See below for more information how to deal with missing crop information. In case of Malawi, we use raw data from <a href="https://www.mapspam.info">global SPAM for 2010</a>. Most of the data was already in the right format so we did not use them.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># Create template for ha. Replace "ha" by "fs" or "ci" for other templates.</span>
<span class="fu"><a href="../reference/create_statistics_template.html">create_statistics_template</a></span>(<span class="st">"ha"</span>, <span class="no">param</span>)
<span class="co">#&gt; # A tibble: 31 x 43</span>
<span class="co">#&gt;    adm_name adm_code adm_level whea  rice  maiz  barl  mill  sorg  ocer  pota </span>
<span class="co">#&gt;    &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;lgl&gt;</span>
<span class="co">#&gt;  1 Malawi   MWI              0 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  2 Central~ MI02             1 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  3 Norther~ MI03             1 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  4 Souther~ MI04             1 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  5 Dedza    MI02001          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  6 Dowa     MI02002          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  7 Kasungu  MI02003          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  8 Lilongwe MI02004          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt;  9 Mchinji  MI02005          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt; 10 Nkhotak~ MI02006          2 NA    NA    NA    NA    NA    NA    NA    NA   </span>
<span class="co">#&gt; # ... with 21 more rows, and 32 more variables: swpo &lt;lgl&gt;, yams &lt;lgl&gt;,</span>
<span class="co">#&gt; #   cass &lt;lgl&gt;, orts &lt;lgl&gt;, bean &lt;lgl&gt;, chic &lt;lgl&gt;, cowp &lt;lgl&gt;, pige &lt;lgl&gt;,</span>
<span class="co">#&gt; #   lent &lt;lgl&gt;, opul &lt;lgl&gt;, soyb &lt;lgl&gt;, grou &lt;lgl&gt;, cnut &lt;lgl&gt;, oilp &lt;lgl&gt;,</span>
<span class="co">#&gt; #   sunf &lt;lgl&gt;, rape &lt;lgl&gt;, sesa &lt;lgl&gt;, ooil &lt;lgl&gt;, sugc &lt;lgl&gt;, sugb &lt;lgl&gt;,</span>
<span class="co">#&gt; #   cott &lt;lgl&gt;, ofib &lt;lgl&gt;, coff &lt;lgl&gt;, coco &lt;lgl&gt;, teas &lt;lgl&gt;, toba &lt;lgl&gt;,</span>
<span class="co">#&gt; #   bana &lt;lgl&gt;, plnt &lt;lgl&gt;, trof &lt;lgl&gt;, temf &lt;lgl&gt;, vege &lt;lgl&gt;, rest &lt;lgl&gt;</span></pre></body></html></div>
<p>For processing it is easier to transform the data into the <strong>long</strong> format, which is similar to the <a href="https://tidyr.tidyverse.org/"><strong>tidy</strong> data format</a> as implemented by the tidyverse packages. In our case this means that the 40 crop columns are squeezed into two columns, one with the crop code and another with the data. The <code>gather()</code> and <code>spread()</code> in the <a href="https://tidyr.tidyverse.org/">tidyr</a> package were designed to help you switch between wide and long tables.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> See below and the Malawi scripts for examples.</p>
</div>
<div id="aggregating-to-spamc-crop-classes" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregating-to-spamc-crop-classes" class="anchor"></a>Aggregating to SPAMc crop classes</h3>
<p>The raw statistics need to be mapped to the 40 crop and crop groups used by SPAMc. The list of crops can be found in <code>crop.csv</code>, which is automatically copied to the <code>mappings</code> folder after running <code><a href="../reference/create_spam_folders.html">create_spam_folders()</a></code>. In practice, almost none of the countries produces all 40 crops. To determine the set of relevant crops, use the list of crops for which FAOSTAT presents data. Running <code>01_process_faostat_crops.r</code> will save a <code>faostat_crop_list.csv</code> file in the <code>processed_data/lists folder</code>. Note that it is no problem to keep all the 40 crops in your database as long as you set their values to <code>NA</code> or <code>-999</code> (see below) so they are automatically removed in the next processing step.</p>
<p>The easiest way to aggregate the raw subnational statistics to the FAOSTAT crop list is to create a <code>orig2crop</code> mapping table, relates the two lists of crops. It might happen that the subnational statistics contain crops that are not present in FAOSTAT. In these cases you have to either not consider them at all, or add them to one of the crops for which FAOSTAT presents data.</p>
<p>The script below illustrates how to aggregate the raw statistics to the SPAMc crops. Note that it important to use sum with <code>na.rm = FALSE</code> as otherwise <code>NA+NA</code> will result in <code>0</code> not <code>NA</code>. This is crucial as missing data in the statistics need to be set to <code>NA</code> for SPAMc in order to process them correctly. If administrative units need to be aggregated a similar approach using a mapping table can be used.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># NB: use sum with na.rm = F as we want NA+NA = NA, not NA+NA = 0!</span>
<span class="no">stat</span> <span class="kw">&lt;-</span> <span class="no">stat</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">orig2crop</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">crop</span>, <span class="no">adm_code</span>, <span class="no">adm_name</span>, <span class="no">adm_level</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarize</span>(<span class="kw">value_ha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">value_ha</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="no">F</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()</pre></body></html></div>
</div>
<div id="treatment-of-missing-data" class="section level3">
<h3 class="hasAnchor">
<a href="#treatment-of-missing-data" class="anchor"></a>Treatment of missing data</h3>
<p>It is unlikely that you will find subnational statistics for all the relevant crops in a country. As a minimum requirement, SPAMc needs full national level statistics for each crop. This is generally no problem as harvested area statistics can be taken from FAOSTAT. Farming system shares and cropping intensity data might be more difficult to get and often require making some strong assumptions. At the subnational level, it is no problem to have missing values for harvested area as this will simply put less constraints on how national data is allocated to the grid cells. Full farming system share and cropping intensity data is only needed at administrative level 1 if the model is run at level 1 (solve level = 1) and never at administrative level 2.</p>
<p>In case data on harvested area is missing for a certain administrative unit, you can indicate this by using <code>NA</code> or <code>-999</code>. We highly recommend using the latter, particularly if you are using Excel to process the data as it avoids potential errors that may result between an <code>NA</code> and an empty string <code>""</code> value. These are both displayed as empty cells in Excel but will be treated differently by R after loading the file. Replacing <code>NA</code> values by <code>-999</code> can be done simultaneously when putting the data in the wide format.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># Put in preferred mapspam format, adding -999 for missing values</span>
<span class="no">stat_mapspam</span> <span class="kw">&lt;-</span> <span class="no">stat</span> <span class="kw">%&gt;%</span>
  <span class="fu">spread</span>(<span class="no">crop</span>, <span class="no">value_ha</span>, <span class="kw">fill</span> <span class="kw">=</span> -<span class="fl">999</span>) <span class="kw">%&gt;%</span>
  <span class="fu">arrange</span>(<span class="no">adm_code</span>, <span class="no">adm_code</span>, <span class="no">adm_level</span>)</pre></body></html></div>
<p>As pointed out above, it is safe to set all values for a crop to <code>NA</code> or <code>-999</code> when the crop is not relevant for the country. Also not that having information on regions where a crop is not grown is also informative! If this is the case, simply set the physical area values to 0 for these regions and the rest to <code>NA</code> or <code>-999</code>. In this way the model will only allocate statistics to the regions where data is missing.</p>
</div>
<div id="data-consistency" class="section level3">
<h3 class="hasAnchor">
<a href="#data-consistency" class="anchor"></a>Data consistency</h3>
<p>Data should be always consistent and add up, meaning that the sum of harvested area for all administrative units and a given crop is the same or smaller (in case of missing information) as the corresponding higher level unit. The script to check the statistics includes a function to reaggregate the data from the bottom up and check for consistency. It is however, essential that you check for consistency yourself before as otherwise a large bias might be introduced resulting in completely erroneous data. For example if there is error in the raw harvested area statistics for maize at a certain administrative level 2 region. AS a result the sum of harvested maize area of all level 2 units is much higher than the maize area of the corresponding level 1 unit, which is a clear inconsistency. The function that reaggregates the statistics will simply take the level 2 total for maize and substitute the level 1 maize data. This error is subsequently carried forward when the maize area for all level 1 unit are aggregated to the national total. The final data table will have maize data that is strongly biased upwards.</p>
</div>
</div>
<div id="check-and-calibrate-subnational-statistics" class="section level2">
<h2 class="hasAnchor">
<a href="#check-and-calibrate-subnational-statistics" class="anchor"></a>Check and calibrate subnational statistics</h2>
<p>Now most hard work is done, the ha, fs and cs files need to be checked for consistency and calibrated to the FAOSTAT national statistics. This is done in <code>03_check_and_calibrate_statistics.r</code>. The first step is to check if the data is consistent, which is done by <code><a href="../reference/check_statistics.html">check_statistics()</a></code>. If <code>out = TRUE</code> is set a report is returned which shows where the inconsistencies occur.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Check the consistency of the ha statistics</span>
<span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span>(<span class="no">ha_df</span>, <span class="no">param</span>, <span class="kw">out</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="co">#&gt; adm0 and adm1 are not equal!. Did you run rebalance_stat?</span>
<span class="co">#&gt; # A tibble: 29 x 4</span>
<span class="co">#&gt; # Groups:   crop [29]</span>
<span class="co">#&gt;    crop     adm0    adm1 difference</span>
<span class="co">#&gt;    &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt;  1 bana    18342   18208        134</span>
<span class="co">#&gt;  2 bean   281065  281058          7</span>
<span class="co">#&gt;  3 cass   193993  193932         61</span>
<span class="co">#&gt;  4 chic   128936  128933          3</span>
<span class="co">#&gt;  5 coff     3001    3001          0</span>
<span class="co">#&gt;  6 cott    63552   63552          0</span>
<span class="co">#&gt;  7 cowp    64297   64297          0</span>
<span class="co">#&gt;  8 grou   290092  290093         -1</span>
<span class="co">#&gt;  9 lent     1904    1905         -1</span>
<span class="co">#&gt; 10 maiz  1660214 1660044        170</span>
<span class="co">#&gt; # ... with 19 more rows</span></pre></body></html></div>
<p>To reaggreate the statistics from the bottom up, use <code><a href="../reference/reaggregate_statistics.html">reaggregate_statistics()</a></code>.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Reaggreate from the bottom up.</span>
<span class="no">ha_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/reaggregate_statistics.html">reaggregate_statistics</a></span>(<span class="no">ha_df</span>, <span class="no">param</span>)

<span class="co"># Check again.</span>
<span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span>(<span class="no">ha_df</span>, <span class="no">param</span>, <span class="kw">out</span> <span class="kw">=</span> <span class="no">T</span>)</pre></body></html></div>
<p>Next, the statistics are calibrated to the national FAOSTAT statistics. The code below shows how this is implemented. First, the code checks if there are still crops included which are not in the FAOSTAT data and removed them if needed. Next, the crops are identified that are not present in the statisitics and the national total is added from the FAOSTAT database. Finally all the subnational statistics are proportionally scaled so the total is equal to the FAOSTAT figures.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># Identify crops that are present in ha_df but not in fao and remove them from ha_df.</span>
<span class="no">crop_rem</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">ha_df</span>$<span class="no">crop</span>), <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">fao</span>$<span class="no">crop</span>))
<span class="no">ha_df</span> <span class="kw">&lt;-</span> <span class="no">ha_df</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(!<span class="no">crop</span> <span class="kw">%in%</span> <span class="no">crop_rem</span>)

<span class="co"># Identify crops that are present in fao but not in ha_df.</span>
<span class="co"># We will add then to ha_df</span>
<span class="no">crop_add</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">fao</span>$<span class="no">crop</span>), <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">ha_df</span>$<span class="no">crop</span>))
<span class="no">ha_df</span> <span class="kw">&lt;-</span> <span class="no">ha_df</span> <span class="kw">%&gt;%</span>
  <span class="fu">bind_rows</span>(
    <span class="no">fao</span> <span class="kw">%&gt;%</span>
      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">crop</span> <span class="kw">%in%</span> <span class="no">crop_add</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(
        <span class="kw">fips</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">ha_df</span>$<span class="no">adm_code</span>[<span class="no">ha_df</span>$<span class="no">adm_level</span><span class="kw">==</span><span class="fl">0</span>]),
        <span class="kw">adm_level</span> <span class="kw">=</span> <span class="fl">0</span>,
        <span class="kw">adm</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">ha_df</span>$<span class="no">adm_name</span>[<span class="no">ha_df</span>$<span class="no">adm_level</span><span class="kw">==</span><span class="fl">0</span>])))

<span class="co"># Calculate scaling factor</span>
<span class="no">fao_stat_sf</span> <span class="kw">&lt;-</span><span class="fu">bind_rows</span>(
  <span class="no">fao</span> <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">source</span> <span class="kw">=</span> <span class="st">"fao"</span>),
  <span class="no">ha_df</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">adm_level</span> <span class="kw">==</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">source</span> <span class="kw">=</span> <span class="st">"ha_df"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">crop</span>, <span class="no">source</span>, <span class="no">ha</span>) <span class="kw">%&gt;%</span>
  <span class="fu">spread</span>(<span class="no">source</span>, <span class="no">ha</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">sf</span> <span class="kw">=</span> <span class="no">fao</span>/<span class="no">ha_df</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">crop</span>, <span class="no">sf</span>)

<span class="co"># rescale ha_df</span>
<span class="no">ha_df</span> <span class="kw">&lt;-</span> <span class="no">ha_df</span> <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">fao_stat_sf</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">ha</span> <span class="kw">=</span> <span class="no">ha</span> * <span class="no">sf</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(-<span class="no">sf</span>)</pre></body></html></div>
<p>Finally the three files (ha, fs and ci), need to be save in the `processed_data/agricultural_statistics folders. It is important to use the correct names otherwise other functions cannot find the data.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu">write_csv</span>(<span class="no">ha_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">param</span>$<span class="no">spamc_path</span>, <span class="fu">glue</span>(<span class="st">"processed_data/agricultural_statistics/ha_adm_{param$year}_{param$iso3c}.csv"</span>)))
<span class="fu">write_csv</span>(<span class="no">fs_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">param</span>$<span class="no">spamc_path</span>, <span class="fu">glue</span>(<span class="st">"processed_data/agricultural_statistics/fs_adm_{param$year}_{param$iso3c}.csv"</span>)))
<span class="fu">write_csv</span>(<span class="no">ci_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">param</span>$<span class="no">spamc_path</span>, <span class="fu">glue</span>(<span class="st">"processed_data/agricultural_statistics/ci_adm_{param$year}_{param$iso3c}.csv"</span>)))</pre></body></html></div>
<p>Now most of the hard work is done, the next step is to <a href="process_spatial_data.html">process the spatial data</a>.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Note that these functions have recently been replaced by <code>pivot_long()</code> and <code>pivot_wide()</code>. In a next update we will use these as well.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
