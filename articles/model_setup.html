<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Model setup • mapspamc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Model setup">
<meta property="og:description" content="mapspamc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapspamc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Background</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/crop_distribution_maps.html">Crop distribution maps</a>
        </li>
        <li>
          <a href="../articles/model_description.html">Model description</a>
        </li>
        <li>
          <a href="../articles/input_data.html">Input data</a>
        </li>
        <li>
          <a href="../articles/country_examples.html">Country examples</a>
        </li>
        <li>
          <a href="../articles/appendix.html">Appendix</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Run mapspamc</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/design.html">Design and process flow</a>
        </li>
        <li>
          <a href="../articles/model_setup.html">1. Model setup</a>
        </li>
        <li>
          <a href="../articles/preprocessing_subnational_statistics.html">2.1. Pre-processing - subnational statistics</a>
        </li>
        <li>
          <a href="../articles/preprocessing_spatial_data.html">2.2. Pre-processing - spatial data</a>
        </li>
        <li>
          <a href="../articles/preprocessing_cropland.html">2.3. Pre-processing - cropland</a>
        </li>
        <li>
          <a href="../articles/preprocessing_irrigated_area.html">2.4. Pre-processing - irrigated area</a>
        </li>
        <li>
          <a href="../articles/model_preparation.html">3. Model preparation</a>
        </li>
        <li>
          <a href="../articles/run_model.html">4. Run model</a>
        </li>
        <li>
          <a href="../articles/postprocessing.html">5. Post-processing</a>
        </li>
        <li>
          <a href="../articles/model_validation.html">6. Model validation</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/michielvandijk/mapspamc" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Model setup</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/michielvandijk/mapspamc/blob/HEAD/vignettes/model_setup.Rmd" class="external-link"><code>vignettes/model_setup.Rmd</code></a></small>
      <div class="hidden name"><code>model_setup.Rmd</code></div>

    </div>

    
    
<p>To create crop distribution maps with <code>mapspamc</code>, several
parameters need to be set first (note that we assume that the
<code>mapspamc</code> package and other required software has been
already <a href="installation.html">installed</a> and is working).</p>
<div class="section level2">
<h2 id="create-model-template">Create model template<a class="anchor" aria-label="anchor" href="#create-model-template"></a>
</h2>
<p>The first step is to create a project with RStudio, activate the
<code>mapspamc</code> package by typing <code><a href="https://github.com/michielvandijk/mapspamc" class="external-link">library("mapspamc")</a></code>
and use the <code>create_model_template</code> function to create a set
of template folders and scripts that implement the six steps to create
crop distribution maps with <code>mapspamc</code>. An alternative
approach would be to copy all the scripts from one of the <a href="country_examples.html">country examples</a> into the RStudio
project and use those as a starting point. In the vignettes, We will use
the scripts of the Malawi example for illustration.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First create a new RStudio project (here we use the name mapspamc_mwi but any name is possible) in the folder c:/temp (or a location of your choice).</span></span>
<span></span>
<span><span class="co"># Load mapspamc</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/michielvandijk/mapspamc" class="external-link">"mapspamc"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the model template in the RStudio project folder</span></span>
<span><span class="fu"><a href="../reference/create_model_template.html">create_model_template</a></span><span class="op">(</span><span class="st">"c:/temp/mapspamc_mwi"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-the-model-parameters-and-the-location-of-the-files">Set the model parameters and the location of the files<a class="anchor" aria-label="anchor" href="#set-the-model-parameters-and-the-location-of-the-files"></a>
</h2>
<p>Nearly all functions in <code>mapspamc</code> need input on (a) key
parameters that determine the design of the model and how it is solved;
(b) the location of the mapspamc database with the raw data that will be
further processed and (c) the location of the model itself. All these
pieces of information are bundled in a <code>mapspamc_par</code> object
that is generated by the function <code>set_mapspamc_par()</code>. This
functions is called in the script
<code>01_model_setup\01_model_setup.R</code>. As the model parameters
are input into all all functions, this script is always loaded at the
beginning of all the other scripts using the <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source()</a></code>
command. In this way, you only have to provide the parameter once. It
also ensures that all the necessary packages are loaded into R.</p>
<p>The following model parameters need to be set before
<code>mapspamc</code> can be run:</p>
<ul>
<li><p><strong>iso3c country code (<code>iso3c</code>).</strong> The
three letter ISO 3166-1 alpha-3 country code, also referred to as iso3c
is used to extract national statistics from global datasets. A list of
country codes can be found in <a href="https://en.wikipedia.org/wiki/ISO_3166-1_alpha-3" class="external-link">Wikipedia</a>.</p></li>
<li><p><strong>Year (<code>year</code>).</strong> The year (four digits)
will be used to select relevant global datasets when data is available
for multiple years, in particular the FAOSTAT national statistics and
population maps. It is also useful to distinguish <code>mapspamc</code>
output when the model is used to create crop distribution maps for
multiple years.</p></li>
<li><p><strong>Spatial resolution (<code>res</code>).</strong> The user
can choose between two spatial resolutions: 30 arc seconds (~1x1 km at
the equator) by selecting <code>"30sec"</code> and 5 arc minutes (~10x10
km at the equator) by selecting <code>"5min"</code>. Note that selecting
a resolution of 30 arcsec increases the model dimensions (number of grid
cells) by a factor 100! This might mean the model becomes too big to
solve and/or your computer runs out of memory. We recommend
experimenting with the 5 arc minute resolution first!</p></li>
<li><p><strong>Depth of subnational statistics
(<code>adm_level</code>).</strong> This parameter defines the most
detailed level at which data for subnational administrative units are
available. Accepted inputs are <code>0</code> (only national level
data), <code>1</code> (national level and first level subnational data)
and <code>2</code> (national level, first and second level subnational
data). In most cases first level data refers to states and provinces and
second level data indicates districts, counties and departments. In the
unusual case that only national and district level data is available,
the user should set <code>adm_level</code> to 1 as the depth of the
subnational statistics is 1.</p></li>
<li><p><strong>Level at which the model is solved
(<code>solve_level</code>).</strong> The model can be solved at the
national level (<code>0</code>) or at the subnational level 1
(<code>1</code>). In the first case, all grid cells are optimized using
national level constraints. This means that for crops for which no
subnational level information is available, the national statistics for
this crop will be distributed over the whole country, subject to the
standard model constraints. In the second case, the model is split into
several administrative level 1 models, which are each solved separately.
Breaking the model up in smaller pieces will result in less complex and
less memory intensive models, which are easier to solve. The
disadvantage is that the subnational level models require
<strong>full</strong> level 1 administrative unit information
(i.e. harvested area statistics, cropping intensity statistics and
production system shares) for all crops that are cultivated in the level
1 administrative unit. For most countries, the subnational statistics
tend to be incomplete and full crop information is only available at the
national level (from FAOSTAT). Hence, the only way to run the model at
the level 1 administrative unit is to impute the missing crop area
values (e.g. by taking values for comparable crops for which information
is available, use national values or look for secondary information).
Running the model at level 1 administrative unit is most useful for
larger countries, such as China, Brazil and the USA, for which detailed
subnational statistics are available and models tend to be large and
complex due to the large size of the country.</p></li>
<li><p><strong>Type of model (‘model’).</strong> You can choose between
two types of models: (1) minimization of cross-entropy
(’min_entropy<code>) and (2) maximization of fitness score (</code>max_score`)
See the section on <a href="model_description.html">Model
description</a> for details.</p></li>
</ul>
<p>The Location of the following three folders need to be added when
setting up the model:</p>
<ul>
<li><p><strong>main model folder (<code>model_path</code>).</strong>
This folder will be used to store all model related data, including
processed data, mapping tables, intermediate output, final results and,
unless specified otherwise by the user, the raw data.</p></li>
<li><p><strong>Location of mapspam_db (<code>db_path</code>).</strong>
Optionally the user can set a folder for the location of the mapspamc
database. This might be convenient if you want to use a server to store
the database (&gt; 5 GB). A folder with the name
<code>mapspamc_db</code> will automatically be created in the
<code>db_path</code> set by the user. If <code>db_path</code> is not
specified the <code>mapspamc_db</code> folder will be created inside the
<code>model_db</code> folder.</p></li>
<li><p><strong>Location of GAMS (<code>gams_path</code>).</strong>
Optionally the user can set a folder for the location of GAMS, which
also includes the GAMS libraries that are needed to load GAMS gdx files
with R. If GAMS was installed properly, <code>mapspamc</code> will
automatically find the GAMS system directory. However, sometimes the
location is not stored correctly, resulting in errors. We therefore
always recommend setting the location of GAMS manually. This might also
be convenient when multiple versions of GAMS are installed on one
machine and one version is preferred over the other.</p></li>
</ul>
<p>The example below sets the <code>mapspamc</code> parameters for
Malawi and stores them in an object called <code>param</code>. Param is
an arbitrary name but we recommend not to change it as we consistently
refer to <code>param</code> in the template scripts and use it in the
documentation of most functions.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load mapspamc</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/michielvandijk/mapspamc" class="external-link">"mapspamc"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the folder where the model will be stored</span></span>
<span><span class="co"># Note that R uses forward slashes even in Windows!!</span></span>
<span><span class="va">model_path</span> <span class="op">&lt;-</span> <span class="st">"c:/temp/mapspamc_mwi"</span></span>
<span></span>
<span><span class="co"># Creates a database folder with the name mapspamc_db in c:/temp.</span></span>
<span><span class="va">db_path</span> <span class="op">&lt;-</span> <span class="st">"c:/temp"</span></span>
<span></span>
<span><span class="co"># Sets the location of the version of GAMS that will be used to solve the model</span></span>
<span><span class="va">gams_path</span> <span class="op">&lt;-</span> <span class="st">"C:/MyPrograms/GAMS/35"</span></span>
<span></span>
<span><span class="co"># Set mapspamc parameters for the min_entropy_5min_adm_level_2_solve_level_0 model</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mapspamc_par.html">mapspamc_par</a></span><span class="op">(</span></span>
<span>  model_path <span class="op">=</span> <span class="va">model_path</span>,</span>
<span>  db_path <span class="op">=</span> <span class="va">db_path</span>,</span>
<span>  gams_path <span class="op">=</span> <span class="va">gams_path</span>,</span>
<span>  iso3c <span class="op">=</span> <span class="st">"MWI"</span>,</span>
<span>  year <span class="op">=</span> <span class="fl">2010</span>,</span>
<span>  res <span class="op">=</span> <span class="st">"5min"</span>,</span>
<span>  adm_level <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  solve_level <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  model <span class="op">=</span> <span class="st">"min_entropy"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span>
<span><span class="co">#&gt; country name:  Malawi </span></span>
<span><span class="co">#&gt; iso3n:  454 </span></span>
<span><span class="co">#&gt; iso3c:  MWI </span></span>
<span><span class="co">#&gt; continent:  Africa </span></span>
<span><span class="co">#&gt; year:  2010 </span></span>
<span><span class="co">#&gt; model:  min_entropy </span></span>
<span><span class="co">#&gt; resolution:  5min </span></span>
<span><span class="co">#&gt; adm level:  2 </span></span>
<span><span class="co">#&gt; solve level:  0 </span></span>
<span><span class="co">#&gt; model path:  c:/temp/mapspamc_mwi </span></span>
<span><span class="co">#&gt; mapspamc_db path:  c:/temp/mapspamc_db </span></span>
<span><span class="co">#&gt; gams path: C:/MyPrograms/GAMS/35 </span></span>
<span><span class="co">#&gt; model folder:  min_entropy_5min_adm_level_2_solve_level_0 </span></span>
<span><span class="co">#&gt; crs:  epsg:4326</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-a-folder-structure">Create a folder structure<a class="anchor" aria-label="anchor" href="#create-a-folder-structure"></a>
</h2>
<p><code>mapspamc</code> includes a function
<code><a href="../reference/create_folders.html">create_folders()</a></code> to create the model structure in
<code>model_path</code> defined by the user . The only input required is
<code>param</code> which contains all the model parameters. The function
will create three folders: (1) <code>mapspamc_db</code> and several
subfolders in <code>model_path</code> (or in the <code>db_path</code> if
specified by the user), where all the raw input data will be stored, (2)
<code>processed_data</code> is used to save all the intermediary data
products as well as the final results and (3) <code>mappings</code>
contains all the lists and mappings that are needed to define the model
(e.g. number crops) and harmonize various data sources (concordance
tables). All tables are in csv format and will be created automatically
into the <code>mappings</code> folder. <code><a href="../reference/create_folders.html">create_folders()</a></code>
will only create csv files if the files do not exist. Hence, updated
files will not be overwritten. If the user wants to recreate the
original tables, simply remove the <code>mappings</code> folder and/or
included files and rerun <code>create_folders</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create folder structure in the mapspamc_path</span></span>
<span><span class="fu"><a href="../reference/create_folders.html">create_folders</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-the-subnational-administrative-unit-map">Prepare the subnational administrative unit map<a class="anchor" aria-label="anchor" href="#prepare-the-subnational-administrative-unit-map"></a>
</h2>
<p>To allocate subnational crop area information, a complementary map
(most likely in the form of a shapefile) with the location of the
subnational administrative units is needed. The processing of this map
is done in the script
<code>01_model_setup\02_prepare_adm_map_and_grid</code>. This involves
multiple steps, which cannot be captured by a single function. These are
explained next.</p>
<p>Before the shapefile can be processed the user needs to load the file
in R by setting the filename (in this case
<code>adm_2010_MWI.shp</code>), which is stored in the
<code>mapspamc_db/adm/</code> folder. For illustrative purposes, we also
added the map (in rds format) to the <code>mapspamc</code> package. The
<code><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">sf::st_transform</a></code> command projects the map to epsg:4326 so
that it is consistent with all the other spatial data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># replace the name of the shapefile with that of your own country.</span></span>
<span><span class="va">iso3c_shp</span> <span class="op">&lt;-</span> <span class="st">"adm_2010_MWI.shp"</span></span>
<span></span>
<span><span class="co"># load shapefile (not needed below as adm_map_raw is stored inside the mapspamc package)</span></span>
<span><span class="co"># adm_map_raw &lt;- read_sf(file.path(param$db_path, glue("adm/{param$iso3c}/{iso3c_shp}")))</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">mapspamc</span><span class="fu">::</span><span class="va">adm_map_raw</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_setup_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Project to standard global projection</span></span>
<span><span class="va">adm_map</span> <span class="op">&lt;-</span> <span class="va">adm_map_raw</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">crs</span><span class="op">)</span></span></code></pre></div>
<p>It is essential that the attribute table (i.e. the table with the
list of subnational administrative units that is attached to the
shapefile) with the names and codes of the administrative units has the
correct column names. To rename to columns, the user has to specify the
column names of the attribute table which contain the original names and
code of the (sub)national units and store them in the
<code>admX_name_orig</code> and <code>admX_code_orig</code> variables,
respectively, where X is the administrative unit level. If you only have
data at level 0 and 1, simply delete the lines of script that refer to
administrative unit level 2, etc. In case of Malawi, we have data at
level 0, 1 and 2 so for each administrative unit level the column names
for name and code need to be set. Columns in the attribute table that
are not relevant will automatically be deleted. The script will also
union all polygons with the same name and code. This is convenient if
the user has crop area information for the combination of two
subnational regions (e.g. ADM A + ADM B) but a shapefile with the
individual polygons of both regions (ADM A &amp; ADM B). In such case,
you can simply give each polygon the same name (e.g. ADM_A_B) and code
(A_B) and they will automatically be dissolved into one polygon.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "AREA"       "PERIMETER"  "G2008_2_"   "G2008_2_ID" "ADM2_CODE" </span></span>
<span><span class="co">#&gt;  [6] "ADM0_CODE"  "ADM0_NAME"  "ADM1_NAME"  "ADM1_CODE"  "ADM2_NAME" </span></span>
<span><span class="co">#&gt; [11] "DISP_AREA"  "LAST_UPDAT" "CONTINENT"  "REGION"     "STR_YEAR0" </span></span>
<span><span class="co">#&gt; [16] "STR_YEAR1"  "STR_YEAR2"  "EXP_YEAR0"  "EXP_YEAR1"  "EXP_YEAR2" </span></span>
<span><span class="co">#&gt; [21] "FIPS0"      "FIPS1"      "FIPS2"      "NAME1"      "NAME2"     </span></span>
<span><span class="co">#&gt; [26] "O_FIPS1"    "O_FIPS2"    "O_NAME1"    "O_NAME2"    "geometry"</span></span>
<span></span>
<span><span class="co"># Set the original names, i.e. the ones that will be replaced. Remove adm1</span></span>
<span><span class="co"># and/or adm2 entries if such data is not available.</span></span>
<span><span class="va">adm0_name_orig</span> <span class="op">&lt;-</span> <span class="st">"ADM0_NAME"</span></span>
<span><span class="va">adm0_code_orig</span> <span class="op">&lt;-</span> <span class="st">"FIPS0"</span></span>
<span><span class="va">adm1_name_orig</span> <span class="op">&lt;-</span> <span class="st">"ADM1_NAME"</span></span>
<span><span class="va">adm1_code_orig</span> <span class="op">&lt;-</span> <span class="st">"FIPS1"</span></span>
<span><span class="va">adm2_name_orig</span> <span class="op">&lt;-</span> <span class="st">"ADM2_NAME"</span></span>
<span><span class="va">adm2_code_orig</span> <span class="op">&lt;-</span> <span class="st">"FIPS2"</span></span>
<span></span>
<span><span class="co"># Replace the names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm0_name_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm0_name"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm0_code_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm0_code"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm1_name_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm1_name"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm1_code_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm1_code"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm2_name_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm2_name"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span> <span class="op">==</span> <span class="va">adm2_code_orig</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"adm2_code"</span></span>
<span></span>
<span><span class="co"># Only select relevant columns</span></span>
<span><span class="va">adm_map</span> <span class="op">&lt;-</span> <span class="va">adm_map</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">adm0_name</span>, <span class="va">adm0_code</span>, <span class="va">adm1_name</span>, <span class="va">adm1_code</span>, <span class="va">adm2_name</span>, <span class="va">adm2_code</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Union separate polygons that belong to the same adm</span></span>
<span><span class="va">adm_map</span> <span class="op">&lt;-</span> <span class="va">adm_map</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">adm0_name</span>, <span class="va">adm0_code</span>, <span class="va">adm1_name</span>, <span class="va">adm1_code</span>, <span class="va">adm2_name</span>, <span class="va">adm2_code</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>.groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    adm0_name <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">country</span>,</span>
<span>    adm0_code <span class="op">=</span> <span class="va">param</span><span class="op">$</span><span class="va">iso3c</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Check names</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 6 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 32.67395 ymin: -14.60495 xmax: 35.2957 ymax: -9.49193</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   adm0_name adm0_code adm1_n…¹ adm1_…² adm2_…³ adm2_…⁴                  geometry</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;POLYGON [°]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Malawi    MWI       Area un… MI01    Area u… MI01001 ((34.07573 -9.526601, 34…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Malawi    MWI       Central… MI02    Dedza   MI02001 ((34.27983 -13.86093, 34…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Malawi    MWI       Central… MI02    Dowa    MI02002 ((33.70179 -13.19747, 33…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Malawi    MWI       Central… MI02    Kasungu MI02003 ((33.58521 -12.44411, 33…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Malawi    MWI       Central… MI02    Lilong… MI02004 ((33.40644 -13.48576, 33…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Malawi    MWI       Central… MI02    Mchinji MI02005 ((33.03184 -13.35057, 33…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with abbreviated variable names ¹​adm1_name, ²​adm1_code, ³​adm2_name,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ⁴​adm2_code</span></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "adm0_name" "adm0_code" "adm1_name" "adm1_code" "adm2_name" "adm2_code"</span></span>
<span><span class="co">#&gt; [7] "geometry"</span></span></code></pre></div>
<p>Polygons of administrative units where no crops can or should be
allocated must be removed. If this is not done, and in the rare case
when the area statistics are larger than the cropland exent, the model
might still allocate crops into these regions. The Malawi shapefile
includes two of such regions. One is the Area under National
Administration, which is the part of Lake Malawi that belongs to Malawi,
and Likoma, several small islands in lake Malawi that are not covered by
the statistics. The script below shows how to remove them. It there is
no reason to remove polygons, simply delete the lines of script in the
template.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set names of ADMs that need to be removed from the polygon.</span></span>
<span><span class="va">adm1_to_remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Area under National Administration"</span><span class="op">)</span></span>
<span><span class="va">adm2_to_remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Likoma"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove ADMs</span></span>
<span><span class="va">adm_map</span> <span class="op">&lt;-</span> <span class="va">adm_map</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adm1_name</span> <span class="op">!=</span> <span class="va">adm1_to_remove</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adm2_name</span> <span class="op">!=</span> <span class="va">adm2_to_remove</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">adm_map</span><span class="op">$</span><span class="va">geometry</span>, main <span class="op">=</span> <span class="st">"ADM polygons removed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model_setup_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>To link the subnational statistics to other spatial data a mapping
table is needed (<code>adm_list</code>) that contains information on how
the administrative units at various levels are nested, which is
precisely the information that is stored in the attribute table of the
administrative unit map. The following code, extracts the list from the
shapefile and saves it as csv file in the
<code>processed_data/lists</code> folder.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create adm_list</span></span>
<span><span class="fu"><a href="../reference/create_adm_list.html">create_adm_list</a></span><span class="op">(</span><span class="va">adm_map</span>, <span class="va">param</span><span class="op">)</span></span></code></pre></div>
<p>After the administrative region shapefile has been processed, save it
in the right location.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temp_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">model_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/maps/adm/{param$res}"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">temp_path</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">adm_map</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"adm_map_{param$year}_{param$iso3c}.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">write_sf</span><span class="op">(</span><span class="va">adm_map</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">temp_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"adm_map_{param$year}_{param$iso3c}.shp"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>By running <code><a href="../reference/create_adm_map_pdf.html">create_adm_map_pdf()</a></code> a pdf file with maps of
the (sub)national regions is created in the
<code>processed_data/maps/adm</code> folder.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create pdf file with the location of administrative units</span></span>
<span><span class="fu"><a href="../reference/create_adm_map_pdf.html">create_adm_map_pdf</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-grid-and-rasterize-the-subnational-administrative-unit-map">Create grid and rasterize the subnational administrative unit
map<a class="anchor" aria-label="anchor" href="#create-grid-and-rasterize-the-subnational-administrative-unit-map"></a>
</h2>
<p>The <code><a href="../reference/create_grid.html">create_grid()</a></code> function creates a spatial grid at
selected spatial resolution (i.e. 30 arc seconds or 5 arc minutes). The
grid is subsequently used by <code><a href="../reference/rasterize_adm_map.html">rasterize_adm_map()</a></code>, which
rasterizes the administrative unit map at the selected resolution. Both
the grid and the rasterized map are required by the model as inputs and
are saved automatically in the right location.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create grid</span></span>
<span><span class="fu"><a href="../reference/create_grid.html">create_grid</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rasterize administrative unit map</span></span>
<span><span class="fu"><a href="../reference/rasterize_adm_map.html">rasterize_adm_map</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
<p>This is all it takes to set up a <code>mapspamc</code> model! The
next step is processing the <a href="preprocessing_subnational_statistics.html">raw subnational
statistics</a> and <a href="preprocessing_spatial_data.html">spatial
data</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
