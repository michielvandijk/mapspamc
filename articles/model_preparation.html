<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4. Model preparation • mapspamc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="4. Model preparation">
<meta property="og:description" content="mapspamc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapspamc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Background</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/crop_distribution_maps.html">Crop distribution maps</a>
        </li>
        <li>
          <a href="../articles/model_description.html">Model description</a>
        </li>
        <li>
          <a href="../articles/input_data.html">Input data</a>
        </li>
        <li>
          <a href="../articles/country_examples.html">Country examples</a>
        </li>
        <li>
          <a href="../articles/appendix.html">Appendix</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Run mapspamc</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/design.html">0. Design and process flow</a>
        </li>
        <li>
          <a href="../articles/model_setup.html">1. Model setup</a>
        </li>
        <li>
          <a href="../articles/preprocessing_subnational_statistics.html">2.1. Pre-processing - subnational statistics</a>
        </li>
        <li>
          <a href="../articles/preprocessing_spatial_data.html">2.2. Pre-processing - spatial data</a>
        </li>
        <li>
          <a href="../articles/preprocessing_cropland.html">2.3. Pre-processing - cropland</a>
        </li>
        <li>
          <a href="../articles/preprocessing_irrigated_area.html">2.4. Pre-processing - irrigated area</a>
        </li>
        <li>
          <a href="../articles/model_preparation.html">3. Model preparation</a>
        </li>
        <li>
          <a href="../articles/run_model.html">4. Run model</a>
        </li>
        <li>
          <a href="../articles/post_processing.html">5. Post-processing</a>
        </li>
        <li>
          <a href="../articles/model_validation.html">6. Model validation</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/michielvandijk/mapspamc" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>4. Model preparation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/michielvandijk/mapspamc/blob/HEAD/vignettes/model_preparation.Rmd" class="external-link"><code>vignettes/model_preparation.Rmd</code></a></small>
      <div class="hidden name"><code>model_preparation.Rmd</code></div>

    </div>

    
    
<p>Now you have created all the necessary input data, it is time to
combine and reshape them so they can be used by <code>mapspamc</code>.
The sections below briefly describe the main functions in mapspamc to do
this. Almost all functions require only one input <code>param</code>, an
object with the <code>mapspamc</code> parameters. Note that ‘under the
hood’ of most functions a lot of other processes are triggered, which
automatically load the data that was created in previous steps, check
them for consistency, reformat them from spatial to data table format
and, where needed, run algorithms to harmonize the various inputs. This
means that some of the functions might take some time to run, in
particular if the resolution is set to 30 arcsec, which considerably
increases the size of the model. All the functions send a message to the
screen when they are processing and when they are finished so you know
what is happening.</p>
<p>All the intermediate data output is saved in the
<code>processed_data/intermediate_output</code> folder. In case you have
set <code>solve_level = 1</code>, the various functions split the data
in administrative level 1 chunks, which are saved in subfolders using
the administrative unit level 1 as name. If <code>solve_level = 0</code>
there will be only one subfolder that used the country iso3c code as
name.</p>
<div class="section level2">
<h2 id="prepare-faostat-crop-prices">Prepare FAOSTAT crop prices<a class="anchor" aria-label="anchor" href="#prepare-faostat-crop-prices"></a>
</h2>
<p>Potential revenue at the grid cell level is used to construct the
scores/priors for the high-input and irrigated farming systems (see <a href="model_description.html">Model description</a> for details).
<code>00_prepare_faostat_crop_prices</code> extracts and prepares this
using the FAOSTAT price database you downloaded before (see <a href="input_data_collection.html">Input data collection</a>). As price
data is often incomplete at the country level, we decided to use
continental averaged prices instead. Make sure sure to set the
<code>faostat_version</code> in the script, which corresponds to the
date the FAOSTAT files were downloaded.</p>
</div>
<div class="section level2">
<h2 id="prepare-cropland">Prepare cropland<a class="anchor" aria-label="anchor" href="#prepare-cropland"></a>
</h2>
<p>The function <code><a href="../reference/prepare_cropland.html">prepare_cropland()</a></code> combines the three
synergy cropland components (medium and maximum cropland and cropland
ranking maps) into a data table and stores this in a file.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prepare_cropland.html">prepare_cropland</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-irrigated-area">Prepare irrigated area<a class="anchor" aria-label="anchor" href="#prepare-irrigated-area"></a>
</h2>
<p><code><a href="../reference/prepare_irrigated_area.html">prepare_irrigated_area()</a></code> is similar to the function that
prepares the cropland as it combines the synergy irrigated area maps
(maximum irrigated area and ranking maps) into one file.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prepare_irrigated_area.html">prepare_irrigated_area</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-statistics">Prepare statistics<a class="anchor" aria-label="anchor" href="#prepare-statistics"></a>
</h2>
<p><code><a href="../reference/prepare_physical_area.html">prepare_physical_area()</a></code> combines the three agricultural
statistics input files (harvested area, farming system shares and
cropping intensity) to calculate the physical cropping area for all
administrative units.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prepare_physical_area.html">prepare_physical_area</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="harmonize-inputs">Harmonize inputs<a class="anchor" aria-label="anchor" href="#harmonize-inputs"></a>
</h2>
<p>Before the <code>mapspamc</code> can be run it is essential to
harmonize the physical, cropland and irrigated area. As this data is
coming from different sources, they will be never consistent. This would
not be a problem if the cropland exent would be larger than the physical
crop area, meaning there would be enough space to allocate the
statistics on the cropland map. Similarly if the total irrigated area in
the irrigated area map would be larger than the physical area of the
irrigated farming systems the data would fit on the map. Unfortunately,
often this does not happen, implying that <code>mapspamc</code> cannot
be solved. In practice, we use ‘slack variables’ to ensure the model
always solves (see <a href="appendix.html">Appendix</a>). However, large
slacks in the solution signal serious inconsistencies in the data and
need to be corrected as much as possible.</p>
<p><code><a href="../reference/harmonize_inputs.html">harmonize_inputs()</a></code> uses a number of steps to harmonize
the various data sources:</p>
<ul>
<li>
<strong>Compare and harmonize Cropland and statistics.</strong> As a
starting point the available cropland is set to the medium cropland
values from the synergy cropland map. For each individual subnational
unit (if data is not missing) and starting with the most detailed level
in the data, the total available (medium) cropland underlying the unit
is compared with the physical area from the statistics that need to be
allocated. If the statistics ‘fit’ no adjustments are made. If they do
not not fit, the administrative unit cropland is expanded by switching
to the maximum cropland value from the synergy cropland map.
Subsequently, the cropland area and physical area are compared again and
a warning is issued when there still is not enough cropland and the
model will introduce slacks to make it solve. In a next iteration, the
cropland and physical area of the units in the subsequent administrative
level are harmonized taking into account the expansion of cropland in
the previous iteration. This continues till cropland and physical area
at the national level are compared and harmonized.</li>
</ul>
<p>In the end, the user has to decide if the slacks are acceptable or
not. In our opinion small slacks (measured as share of total or
administrative unit physical crop area) are no problem to deal with
inconsistencies. However it slacks become very large we recommend
scrutinizing your statistics and where possible make adjustments. Large
slack often results from data entry errors or too rigid cropping
intensity values. We provide some advise on how to deal with slack in
the <a href="appendix.html">Appendix</a>.</p>
<ul>
<li><p><strong>Compare and harmonize irrigated area and
statistics</strong> In the next step, the irrigated area from the
synergy irrigated area map and the irrigated physical area from the
statistics are compared and harmonized. We start by ranking all
irrigated grid cells from the most (rank 1) to the least (rank 10)
reliable. Next, for each grid cell, we set the irrigated area to the
minimum of the cropland area (taken from the previous harmonization
step) and the irrigated area from the synergy irrigated area map. The
grid cells are subsequently aggregated till the accumulated area is
slightly larger than the irrigated physical area from the statistics. If
the physical area turns out to be larger than the total irrigated
cropland, meaning it does not fit, a new iteration is started in which
the irrigated area per grid cell is increased by taking the maximum of
the cropland area and the irrigated area. If this is still not
sufficient, the irrigated area is further enlarged by taking the maximum
of the maximum cropland area and the irrigated area for each grid cell.
It this is still not sufficient a warning is issued that solving the
model will introduce slack. Finally, the grid cell ranking from the
synergy cropland is adjusted to factor in all the selected irrigated
area cells.</p></li>
<li><p><strong>Select grid cells to match with statistics</strong> In
the final harmonization step the cropland and irrigation extent are
compared with the statistics. Similar to the previous step, the grid
cells are ranked and the cropland is aggregated stating with the most
preferred grid cells (now also including the irrigated area grid cells)
till it is slightly larger than the physical area from the (sub)national
statistics. This is consequatively done for each individual
administrative unit starting with the most detailed level and ending at
the national level. This process makes sure that the cropland and
irrigated area extent is reduced to include only the most reliable grid
cells, while at the same time it ensures that they are still large
enough to fit the physical crop area, including the irrigated area. The
final cropland and irrigated area extent consists of the union of grid
cells that are selected at each (sub)national administrative unit
level.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/harmonize_inputs.html">harmonize_inputs</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="prepare-priors-and-scores">Prepare priors and scores<a class="anchor" aria-label="anchor" href="#prepare-priors-and-scores"></a>
</h2>
<p>The only thing left to do in terms of preparing the model input is to
create the priors and the scores. Not surpisingly, this is done by
<code><a href="../reference/prepare_priors_and_scores.html">prepare_priors_and_scores()</a></code>. For convenience, the function
will always create both the priors and the scores as model input even
though one of the two might be redundant because you only want to run
<code>min_entropy</code>, which requires the priors, or
<code>max_score</code>, which requires the scores. In this way, you can
easily change the model type parameter and directly run the model,
without going through the data pre-processing steps.</p>
<p>Note that the function might take a some time to run as it will run
three consecutive processes. First, the biophysical suitability and
potential yield maps for all farming system and crop combinations are
loaded and only grid cells that overlap with the cropland exent from the
previous step are selected, after which all data is merged into one
table and saved. This process also checks if the maps do not only
contain zero values and, where needed, replaces the map by a substitute
crop. This is important because it occasionally happens that the
biophysical suitability and potential yield maps indicate zero
suitability for a specific crop although the statistics indicate it is
produced in the country. If we would not correct for this, most scores
and priors for this crop would be zero, resulting in an ‘uninformed’
allocation of the crop, meaning it can be placed anywhere as long as the
the constraints are satisfied and the objective function (minimization
of cross-entropy or maximization of fitness score) is optimized. In case
all the substitute crops have zero values, a warning is issued. We
prepared a list of substitute crops that is stored in the
<code>mappings/replace_gaez.sv</code> file. You can modify the list to
add other substitute crops if you think these are more appropriate. The
only requirement is that selected crop must be in the list of SPAM crops
that is stored in <code>mappings/crop.csv</code>. The second and third
process create data files with the priors and scores using the
biophysical suitability and potential yield, among others, as input
data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prepare_priors_and_scores.html">prepare_priors_and_scores</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
<p>Finally, all the inputs, including the harmonized cropland extent,
irrigated area extent and statistics, and the priors/scores are combined
in one GAMS gdx file, which is used as input by <code>mapspamc</code>.
The file contains a number of sets and parameter tables that define the
model. Sets describe the dimensions of the model, while parameters
contain the data along these dimensions. As part of the process to
combine all the inputs and if relevant, artificial administrative units
are created that represent the combination of all administrative units
per crop for which subnational statistics are missing. These units are
added to the list of administrative units from the subnational
statistics. The names of these units, stored in the
<code>adm_area</code> parameter table, start with the name of the lower
level administrative unit which nests the units with missing data,
followed by <code>ART</code> and the level for which data is missing and
ending with the crop for which data is not available.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/combine_inputs.html">combine_inputs</a></span><span class="op">(</span><span class="va">param</span><span class="op">)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
