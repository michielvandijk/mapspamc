<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2.1. Pre-processing: Subnational statistics • mapspamc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2.1. Pre-processing: Subnational statistics">
<meta property="og:description" content="mapspamc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapspamc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Background</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/crop_distribution_maps.html">Crop distribution maps</a>
        </li>
        <li>
          <a href="../articles/model_description.html">Model description</a>
        </li>
        <li>
          <a href="../articles/input_data.html">Input data</a>
        </li>
        <li>
          <a href="../articles/country_examples.html">Country examples</a>
        </li>
        <li>
          <a href="../articles/appendix.html">Appendix</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Run mapspamc</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/design.html">Design and process flow</a>
        </li>
        <li>
          <a href="../articles/model_setup.html">1. Model setup</a>
        </li>
        <li>
          <a href="../articles/preprocessing_subnational_statistics.html">2.1. Pre-processing - subnational statistics</a>
        </li>
        <li>
          <a href="../articles/preprocessing_spatial_data.html">2.2. Pre-processing - spatial data</a>
        </li>
        <li>
          <a href="../articles/preprocessing_cropland.html">2.3. Pre-processing - cropland</a>
        </li>
        <li>
          <a href="../articles/preprocessing_irrigated_area.html">2.4. Pre-processing - irrigated area</a>
        </li>
        <li>
          <a href="../articles/model_preparation.html">3. Model preparation</a>
        </li>
        <li>
          <a href="../articles/run_model.html">4. Run model</a>
        </li>
        <li>
          <a href="../articles/postprocessing.html">5. Post-processing</a>
        </li>
        <li>
          <a href="../articles/model_validation.html">6. Model validation</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/michielvandijk/mapspamc" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2.1. Pre-processing: Subnational statistics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/michielvandijk/mapspamc/blob/HEAD/vignettes/preprocessing_subnational_statistics.Rmd" class="external-link"><code>vignettes/preprocessing_subnational_statistics.Rmd</code></a></small>
      <div class="hidden name"><code>preprocessing_subnational_statistics.Rmd</code></div>

    </div>

    
    
<p>Subnational statistics on harvested area are a key input for
<code>mapspamc</code>. Before they can be used the data need to be put
in the right format, made consistent and aggregated (or split) to the
crops and production systems that are used by <code>mapspamc</code>.
Unfortunately, the level of detail (e.g. number of crops covered at the
level 1 and 2 administrative unit) and quality (do lower levels of
subnational data add up to higher levels?) of these statistics may
differ considerably across countries. Cleaning, harmonizing and
preparing the crop statistics is probably the most time consuming and
difficult part of running <code>mapspamc</code>.</p>
<p>In many cases the user has to make a value judgment on which
statistics to keep and which to discard in order to make them
consistent. There is no simple formula or function that makes it
possible to (semi) automatically prepare the raw subnational statistics
so that they can be used by <code>mapspamc</code> and therefore it
requires a substantial amount of user input and ad hoc coding to prepare
the data.</p>
<p>We prefer to break down the processing and preparation of the
subnational statistics into two steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Processing of raw subnational statistics.</strong> In this
step, the raw statistics, meaning the various data files that were
downloaded from the national statistical office or taken from other
sources, are reshaped, aggregated and cleaned so that they are (almost)
ready to be used by <code>mapspamc</code>.</li>
<li>
<strong>Checking and calibrating processed subnational
statistics.</strong>: In this step, the processed statistics are checked
for consistency, adjusted where needed and calibrated to the FAOSTAT
national statistics.</li>
</ol>
<p>The scripts to prepare the data for Malawi offer some guidance on how
to organize these two steps and can be adapted where needed. They are
located in the <code>02_1_pre_procesing_statistics</code> folder. They
also illustrate the use of several functions and tools that we developed
to support the process. We recommend to code all the steps that are
needed to process the statistics in R so everything is documented and
fully reproducible. The <a href="https://tidyr.tidyverse.org/" class="external-link">tidyr</a>
and <a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a> packages offer a
variety of functions that were specifically designed to clean up and
process ‘messy’ data. It is also possible to use Excel or any other
software to process the raw statistics as long as the output is saved in
the correct format so that they can be used for further processing.
Obviously a major disadvantage of using Excel is that it will be very
difficult to track changes or quickly make adjustments when new data
becomes available.</p>
<div class="section level2">
<h2 id="support-scripts">Support scripts<a class="anchor" aria-label="anchor" href="#support-scripts"></a>
</h2>
<p>Apart from the main scripts that clean and check the statistics,
which will be discussed below, the template contains two other scripts
that support these processes.</p>
<ul>
<li><code>01_process_faostat_crops.R</code></li>
<li><code>02_process_faostat_crop_prices.R</code></li>
</ul>
<p>The first script processes the national FAOSTAT crop statistics.
These are used for two purposes. The first is for calibration of the
subnational statistics so they are in line with FAOSTAT. As FAOSTAT is
the leading source of agricultural data, it is useful to ensure that the
subnational data adds up to the FAOSTAT national totals. For many
countries the totals will already be the same or at least in the same
range as the FAOSTAT data because subnational agricultural statistics
are often the basis for the construction of the national statistics,
which in turn are used as input by FAOSTAT. Nonetheless, one might also
encounter large differences between the two sources of data. The second
purpose is to determine the list of crops that is needed to prepare the
subnational agricultural statistics. We will discuss this further below.
Make sure to run <code>01_process_faostat_crops.R</code> before starting
to prepare the subnational statistics.</p>
<p>The second script extracts the crop prices from FAOSTAT, which are
needed to calculate the potential revenue at the grid cell level, which
is used to construct the scores/priors for the high-input and irrigated
production systems (see <a href="model_description.html">Model
description</a> for details). As price data is often incomplete at the
country level, we decided to use continental averaged prices
instead.</p>
</div>
<div class="section level2">
<h2 id="processing-of-raw-subnational-statistics">Processing of raw subnational statistics<a class="anchor" aria-label="anchor" href="#processing-of-raw-subnational-statistics"></a>
</h2>
<p>The <code>03_prepare_subnational_statistics.r</code> can be used to
store all code that is needed to process the raw subnational statistics.
In the case of Malawi, we took all data from SPAM2010 and therefore it
was already in the right format. As no further adjustments were needed,
we did not prepare additional code to process the data. Nonetheless, we
discuss several key processing steps that most users will need to go
through when preparing the subnational statistics for a country
case-study.</p>
<p>Three files with subnational statistical information need to be
created, which will be combined later:</p>
<ol style="list-style-type: decimal">
<li>A file with <strong>Harvest area statistics (ha)</strong> in
hectares for all subnational administrative unit at each level.</li>
<li>A file with <strong>Cropping intensity (ci)</strong> for each
subnational administrative unit at the national level. If the model is
solved at the subnational level 1 (by setting <code>solve_level</code>
to 1), also cropping intensity data is required at subnational level
1.</li>
<li>A file with <strong>production system area shares (ps)</strong> (not
percentages!) for each subnational administrative unit at the national
level (same format as the cropping intensity information).</li>
</ol>
<p>It is best to start with processing the harvest area statistics and
then work on the files with cropping intensity and production system
shares. Data for these three files is most likely coming from different
sources and can be processed independently. Also cropping intensity and,
to a lesser extent, production system shares data, sometimes needs to be
adjusted after running the model as it may occur that there is not
enough cropland to allocate all the harvested area from the statistics,
which suggests that the cropping intensity is too low for some
regions.</p>
<div class="section level3">
<h3 id="putting-the-subnational-statistics-in-the-right-format">Putting the subnational statistics in the right format<a class="anchor" aria-label="anchor" href="#putting-the-subnational-statistics-in-the-right-format"></a>
</h3>
<p>All crop statistics need to be stored in the <strong>wide</strong>
format. With this we mean that the first four columns of the data table
list the administrative unit code (<code>adm_code</code>), name
(<code>adm_name</code>), level (<code>adm_level</code>) and in case of
production system shares or cropping intensity data, the production
system (<code>system</code>), followed by named columns, one for each
crop, with harvested area, production system shares or cropping
intensity per subnational unit. <code>adm_name</code> and
<code>adm_code</code> must be provided up to the most detailed
administrative unit for which data is available. Hence, in case level 2
data is available, data should be supplied for level 0, 1 and 2. In case
only level 1 data is available, data should be supplied for level 0 and
level 1.</p>
<p><code><a href="../reference/create_statistics_template.html">create_statistics_template()</a></code> will create templates for
the harvested area, production system and cropping intensity data files
- also see the Malawi data for examples. The number and depth of the
administrative units will be determined by the model parameters stored
in the <code>mapspamc_par</code> object as well as the
<code>adm_list</code> file that is created with
<code><a href="../reference/create_adm_list.html">create_adm_list()</a></code>. By default, the template will have
columns for all <a href="appendix.html">40 <code>mapspamc</code>
crops</a>.</p>
<p>The user can save the template as csv file and use it as a basis to
prepare the statistics. Note that is is essential that you follow the
template closely! Adding or removing administrative units will result in
errors as the data no longer matches with the map that contains the
location of the administrative units - see below for more information
how to deal with missing crop information. In case of Malawi, most of
the data was already in the right format so there was no need to use the
templates.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create template for ha. Replace "ha" by "ps" or "ci" for other templates.</span></span>
<span><span class="fu"><a href="../reference/create_statistics_template.html">create_statistics_template</a></span><span class="op">(</span><span class="st">"ha"</span>, <span class="va">param</span><span class="op">)</span></span></code></pre></div>
<p>For processing it is easier to transform the data into the
<strong>long</strong> format, which is similar to the <a href="https://tidyr.tidyverse.org/" class="external-link"><strong>tidy</strong> data
format</a> as implemented by the tidyverse packages. In our case this
means that the 40 crop columns are squeezed into two columns, one with
the crop code and another with the data. The <code>pivot_longer()</code>
and <code>pivot_wider()</code> functions in the <a href="https://tidyr.tidyverse.org/" class="external-link">tidyr</a> package were designed to
switch between wide and long tables.</p>
</div>
<div class="section level3">
<h3 id="aggregating-to-mapspamc-crop-classes">Aggregating to <code>mapspamc</code> crop classes<a class="anchor" aria-label="anchor" href="#aggregating-to-mapspamc-crop-classes"></a>
</h3>
<p>The raw statistics need to be mapped to the <a href="appendix.html">40 crops</a> used by <code>mapspamc</code>. The
list of crops can be found in <code>crop.csv</code>, which is
automatically copied to the <code>mappings</code> folder after running
<code>create_spam_folders()</code>. In practice, almost none of the
countries produce all 40 crops. To determine the set of relevant crops,
the user can use the list of crops for which FAOSTAT presents data.
Running <code>01_process_faostat_crops.R</code> will save a
<code>faostat_crop_list.csv</code> file in the
<code>processed_data/lists folder</code>. Note that it is no problem to
keep all the 40 crops in the database as long as the values for crops
that are not grown in a country are set to <code>NA</code> or
<code>-999</code> (see below) so that they are automatically removed
when the data is further processed.</p>
<p>The easiest way to aggregate the raw subnational statistics to the
FAOSTAT crop list is to create an <code>orig2crop</code> concordance
table, which links the two lists of crops. It sometimes happens that the
subnational statistics contain crops that are not present in FAOSTAT. In
such cases, the best solution is to add these crops to one of the crops
for which FAOSTAT presents data.</p>
<p>The script below illustrates how to aggregate the raw statistics to
the <code>mapspamc</code> crops. Note that it is important to use sum
with <code>na.rm = FALSE</code> as otherwise <code>NA+NA</code> will
result in <code>0</code> not <code>NA</code>. This is crucial as missing
data in the statistics need to be set to <code>NA</code> for
<code>mapspamc</code> in order to process them correctly.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NB: use sum with na.rm = F as we want NA+NA = NA, not NA+NA = 0!</span></span>
<span><span class="va">stat</span> <span class="op">&lt;-</span> <span class="va">stat</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">orig2crop</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">crop</span>, <span class="va">adm_code</span>, <span class="va">adm_name</span>, <span class="va">adm_level</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>value_ha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value_ha</span>, na.rm <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="treatment-of-missing-data">Treatment of missing data<a class="anchor" aria-label="anchor" href="#treatment-of-missing-data"></a>
</h3>
<p>It is unlikely that subnational statistics are available for all
crops in a country. As a minimum requirement, <code>mapspamc</code>
needs full national level statistics for each crop. This is generally no
problem as information on harvested area can be taken from FAOSTAT.
production system shares and cropping intensity data are generally more
difficult to find and often require making strong assumptions. Missing
values in the subnational harvested area statistics are allowed. In such
cases the algorithm will automatically change the constraints in order
to substitute the missing data with information from lower level
administrative units. Full information (harvest area statistics,
production system shares and cropping intensity) is only needed at
administrative level 1 if the model is run at level 1
(<code>solve_level</code> = 1) and never for administrative level 2.</p>
<p>In case data on harvested area is missing for a certain
administrative unit, you can indicate this by using <code>NA</code> or
<code>-999</code>. We highly recommend using the latter, particularly if
you are using Excel to process the data because it avoids potential
errors that may result between an <code>NA</code> and an empty string
<code>""</code> value. These are both displayed as empty cells in Excel
but will be treated differently by R after loading the file. Replacing
<code>NA</code> values by <code>-999</code> can be done simultaneously
when putting the data in the wide format.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Put in preferred mapspam format, adding -999 for missing values</span></span>
<span><span class="va">stat_mapspam</span> <span class="op">&lt;-</span> <span class="va">stat</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">crop</span>, value_from <span class="op">=</span> <span class="va">value_ha</span>, values_fill <span class="op">=</span> <span class="op">-</span><span class="fl">999</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">adm_code</span>, <span class="va">adm_code</span>, <span class="va">adm_level</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-consistency">Data consistency<a class="anchor" aria-label="anchor" href="#data-consistency"></a>
</h3>
<p>Data should always be consistent and add up, meaning that the sum of
harvested area for all administrative units and a given crop is the same
or smaller (in case of missing information) as the corresponding lower
level unit. The script to check the statistics includes a function to
reaggregate the data from the bottom up and check for consistency. It is
however, essential that the user also checks whether the data is
consistent in the data processing step as otherwise a large bias might
be introduced resulting in completely erroneous data and model output.
For example, suppose there is an error in the raw harvested area
statistics for maize in a certain level 2 administrative region. As a
result the sum of harvested maize area of all level 2 units is much
higher than the maize area of the corresponding level 1 unit, which is a
clear inconsistency. The function that reaggregates the statistics will
simply take the level 2 total for maize and substitute the level 1 maize
data. This error is subsequently carried forward when the maize area for
all level 1 units are aggregated to the national total. The final data
table will include maize data that is strongly biased upwards.</p>
</div>
</div>
<div class="section level2">
<h2 id="check-and-calibrate-statistics">Check and calibrate statistics<a class="anchor" aria-label="anchor" href="#check-and-calibrate-statistics"></a>
</h2>
<p>After the raw subnational statistics are cleaned and harmonized, the
harvested area, production systems and cropping intensity files need to
be checked for consistency and calibrated to the FAOSTAT national
statistics. This is done in
<code>04_check_and_calibrate_statistics.R</code>. The first step is to
check if the data is consistent, which is done by
<code><a href="../reference/check_statistics.html">check_statistics()</a></code>. If <code>out = TRUE</code> a report is
returned which shows where the inconsistencies occur.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check the consistency of the ha statistics</span></span>
<span><span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span><span class="op">(</span><span class="fu">mapspamc</span><span class="fu">::</span><span class="va">ha_df</span>, <span class="va">param</span>, out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; adm0 and adm1 are not equal!. Did you run reaggregate_statistics()?</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 29 × 4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   crop [29]</span></span></span>
<span><span class="co">#&gt;    crop     adm0    adm1 difference</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> bana    <span style="text-decoration: underline;">18</span>342   <span style="text-decoration: underline;">18</span>208        134</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> bean   <span style="text-decoration: underline;">281</span>065  <span style="text-decoration: underline;">281</span>058          7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> cass   <span style="text-decoration: underline;">193</span>993  <span style="text-decoration: underline;">193</span>932         61</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> chic   <span style="text-decoration: underline;">128</span>936  <span style="text-decoration: underline;">128</span>933          3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> coff     <span style="text-decoration: underline;">3</span>001    <span style="text-decoration: underline;">3</span>001          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> cott    <span style="text-decoration: underline;">63</span>552   <span style="text-decoration: underline;">63</span>552          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> cowp    <span style="text-decoration: underline;">64</span>297   <span style="text-decoration: underline;">64</span>297          0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> grou   <span style="text-decoration: underline;">290</span>092  <span style="text-decoration: underline;">290</span>093         -<span style="color: #BB0000;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> lent     <span style="text-decoration: underline;">1</span>904    <span style="text-decoration: underline;">1</span>905         -<span style="color: #BB0000;">1</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> maiz  1<span style="text-decoration: underline;">660</span>214 1<span style="text-decoration: underline;">660</span>044        170</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 19 more rows</span></span></span></code></pre></div>
<p>To reaggreate the statistics from the bottom up, use
<code><a href="../reference/reaggregate_statistics.html">reaggregate_statistics()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reaggreate from the bottom up.</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reaggregate_statistics.html">reaggregate_statistics</a></span><span class="op">(</span><span class="fu">mapspamc</span><span class="fu">::</span><span class="va">ha_df</span>, <span class="va">param</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check again.</span></span>
<span><span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span><span class="op">(</span><span class="fu">mapspamc</span><span class="fu">::</span><span class="va">ha_df</span>, <span class="va">param</span>, out <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Next, the statistics are calibrated to the national FAOSTAT
statistics. The code below shows how this is implemented. First, the
code checks if there are still crops, which are not in the FAOSTAT data
and removes them if needed. Next, crops are identified that are not
present in the statistics, after which the FAOSTAT national total is
added. Finally all the subnational statistics are proportionally scaled
so the total is equal to the FAOSTAT figures.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify crops that are present in ha_df but not in fao and remove them from ha_df.</span></span>
<span><span class="va">crop_rem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">fao</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">crop</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">crop_rem</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify crops that are present in fao but not in ha_df.</span></span>
<span><span class="co"># We will add then to ha_df</span></span>
<span><span class="va">crop_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">fao</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>    <span class="va">fao</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">crop</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">crop_add</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_code</span><span class="op">[</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_level</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        adm_level <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        adm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_name</span><span class="op">[</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_level</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate scaling factor</span></span>
<span><span class="va">fao_stat_sf</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="va">fao</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>source <span class="op">=</span> <span class="st">"fao"</span><span class="op">)</span>,</span>
<span>  <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adm_level</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>source <span class="op">=</span> <span class="st">"ha_df"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">crop</span>, <span class="va">source</span>, <span class="va">ha</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">spread</span><span class="op">(</span><span class="va">source</span>, <span class="va">ha</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>sf <span class="op">=</span> <span class="va">fao</span> <span class="op">/</span> <span class="va">ha_df</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">crop</span>, <span class="va">sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rescale ha_df</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">fao_stat_sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ha <span class="op">=</span> <span class="va">ha</span> <span class="op">*</span> <span class="va">sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sf</span><span class="op">)</span></span></code></pre></div>
<p>Finally the harvested area, production systems and cropping intensity
files are saved in the
<code>processed_data/agricultural_statistics</code> folder. It is
important to use the correct file names otherwise other functions cannot
load the data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ha_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/ha_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ps_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/ps_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ci_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/ci_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The next step is to <a href="preprocessing_spatial_data.html">process
the spatial data</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
