<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2.1. Pre-processing: Subnational statistics • mapspamc</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2.1. Pre-processing: Subnational statistics">
<meta property="og:description" content="mapspamc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapspamc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Background</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/crop_distribution_maps.html">Crop distribution maps</a>
        </li>
        <li>
          <a href="../articles/model_description.html">Model description</a>
        </li>
        <li>
          <a href="../articles/input_data.html">Input data</a>
        </li>
        <li>
          <a href="../articles/appendix.html">Appendix</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Preparation</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/input_data_collection.html">Collect input data</a>
        </li>
        <li>
          <a href="../articles/country_examples.html">Country examples</a>
        </li>
      </ul>
</li>
    <li class="dropdown-submenu">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Run mapspamc</a>
      <ul class="dropdown-menu" role="menu">
<li>
          <a href="../articles/design.html">0. Design and process flow</a>
        </li>
        <li>
          <a href="../articles/model_setup.html">1. Model setup</a>
        </li>
        <li>
          <a href="../articles/preprocessing_subnational_statistics.html">2.1. Pre-processing - subnational statistics</a>
        </li>
        <li>
          <a href="../articles/preprocessing_spatial_data.html">2.2. Pre-processing - spatial data</a>
        </li>
        <li>
          <a href="../articles/preprocessing_cropland.html">2.3. Pre-processing - cropland</a>
        </li>
        <li>
          <a href="../articles/preprocessing_irrigated_area.html">2.4. Pre-processing - irrigated area</a>
        </li>
        <li>
          <a href="../articles/model_preparation.html">3. Model preparation</a>
        </li>
        <li>
          <a href="../articles/run_model.html">4. Run model</a>
        </li>
        <li>
          <a href="../articles/post_processing.html">5. Post-processing</a>
        </li>
        <li>
          <a href="../articles/model_validation.html">6. Model validation</a>
        </li>
      </ul>
</li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/michielvandijk/mapspamc" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2.1. Pre-processing: Subnational statistics</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/michielvandijk/mapspamc/blob/HEAD/vignettes/preprocessing_subnational_statistics.Rmd" class="external-link"><code>vignettes/preprocessing_subnational_statistics.Rmd</code></a></small>
      <div class="hidden name"><code>preprocessing_subnational_statistics.Rmd</code></div>

    </div>

    
    
<p>Subnational statistics on harvested area are a key input for
<code>mapspamc</code>. Before they can be used the data need to be put
in the right format, made consistent and aggregated (or split) to the
crops and farming systems that are used by <code>mapspamc</code>.
Unfortunately, the level of detail (e.g. coverage of subnational level 1
and 2), coverage (full crop and administrative unit coverage or many
missing values) and quality (do lower levels of administrative unit data
add up to higher levels?) of these statistics may differ enormously
between countries. Cleaning, harmonizing and preparing the subnational
statistics is probably the most time consuming and difficult part of
running <code>mapspamc</code>. In many cases the researcher has to make
a value judgment on which statistics to keep and which to discard in
order to make them consistent. Which data is more reliable if they do
not add up? Administrative unit level 1 or 2? If, the harvested area for
say vegetables seems exceptionally and perhaps unrealistically large in
a certain administrative region, is this a data entry error or is it
really that high? These are decisions that often need to be taken when
preparing the data. There is no simple formula or function that makes it
possible to (semi) automatically prepare the raw subnational statistics
so that they can be used by <code>mapspamc</code>. Unfortunately it
requires a substantial amount of user input and ad hoc coding to get the
data ready.</p>
<p>We prefer to break down the processing and preparation of the
subnational statistics into two steps:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Processing of raw subnational statistics.</strong> In this
step, the raw statistics, meaning the various data files that were
downloaded from the national statistical office or taken from any other
source, are reshaped, aggregated and cleaned so they are (almost) ready
to be used by <code>mapspamc</code>.</li>
<li>
<strong>Checking and calibrating processed subnational
statistics.</strong>: In this step, the processed statistics are checked
for consistency, adjusted where needed and calibrated to the FAOSTAT
national statistics.</li>
</ol>
<p>The scripts to prepare the data for Malawi offer some guidance on how
to organize these two steps and can be adapted where needed. They are
located in the <code>02_subnational_statistics</code> folder. They also
illustrate the use of several functions and tools that we developed to
support the process. We prefer and highly recommend to code all the
steps that are needed to process statistics in R so everything is nicely
documented and fully reproducible. The <a href="https://tidyr.tidyverse.org/" class="external-link">tidyr</a> and <a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a> packages offer a variety
of functions that are specially designed to clean up and process ‘messy’
data. It is also possible to use Excel or any other software to process
the raw national statistics as long as the statistics are saved in the
correct format so they can be used for further processing. Obviously a
major disadvantage of using Excel is that it will be very difficult to
track changes or quickly make adjustments when new data becomes
available and needs to be added.</p>
<div class="section level2">
<h2 id="support-scripts">Support scripts<a class="anchor" aria-label="anchor" href="#support-scripts"></a>
</h2>
<p>Apart from the main scripts that clean and check the statistics,
which will be discussed below, the template contains three other scripts
that support these processes.</p>
<ul>
<li><code>01_process_faostat_crops.r</code></li>
<li><code>04_process_aquastat.r</code></li>
<li><code>05_calculate_irrigated_system_share.r</code></li>
</ul>
<p>The first script prepares the national FAOSTAT statistics. These are
used for two purposes. The first is for calibration of the subnational
statistics so they are in line with FAOSTAT. As FAOSTAT is the leading
source of agricultural data, it is useful to ensure that the subnational
data adds up to the FAOSTAT national totals. For many countries the
totals will already be the same or at least in the same range as FAOSTAT
as subnational agricultural statistics are often the basis for the
construction of the national statistics, which in turn are used as input
by FAOSTAT. Nonetheless, one might also encounter large differences
between the two sources of data. The second purpose is to determine the
list of crops that is needed to prepare the subnational agricultural
statistics. We will discuss this further below. Make sure to run
<code>01_process_faostat_crops.r</code> before starting to prepare the
subnational statistics. Do not forget to set the
<code>faostat_version</code> variable in the script, which corresponds
with the date you added when you downloaded the data
(<code>20200303</code> in the Malawi example).</p>
<p>The second and third script select relevant country data from the
AQUASTAT database and use this to calculate the share of irrigated area
per crop, respectively. This information can be used as input to inform
the irrigated area shares that are needed for the farming system shares
data table (See below). We will not discuss these scripts here. Note
that <code>05_calculate_irrigated_system_share.r</code> needs the
processed harvest area statistics as input so it can only by run at the
end, denoted by the number 05 in the name of the script. Please have a
look and try by yourself.</p>
</div>
<div class="section level2">
<h2 id="processing-of-raw-subnational-statistics">Processing of raw subnational statistics<a class="anchor" aria-label="anchor" href="#processing-of-raw-subnational-statistics"></a>
</h2>
<p>The <code>02_process_raw_national_statistics.r</code> file shows all
the steps we took to process the raw statistics for Malawi (taken from
<a href="https://www.mapspam.info" class="external-link">global SPAM for 2010</a>), put them
into the right format and make them consistent with the shapefile with
the locations of the administrative units. Most of the data was already
in the right format so we did not use them.We highlight several key
steps you probably also need to implement to process the data for your
country.</p>
<p>You need to create three files with subnational statistical
information that will be combined later:</p>
<ol style="list-style-type: decimal">
<li>A file with <strong>Harvest area statistics (ha)</strong> in
hectares for all subnational administrative unit at each level.</li>
<li>A file with the <strong>Cropping intensity (ci)</strong> for each
subnational administrative unit at the national and subnational 1. If
the model is solved at the subnational level 1 (by setting the model
level to 1), also cropping intensity data is required at subnational
level 1.</li>
<li>A file with <strong>Farming system area shares (fs)</strong> (not
percentages!) for each subnational administrative unit at the national
level (same format as the cropping intensity information).</li>
</ol>
<p>It is the best to start with processing the harvest area statistics
and then work on the cropping intensity and farming system shares files.
Data for these three files is most likely coming from different sources
and can be processed independently. Also cropping intensity and to a
lesser extent farming system shares data sometimes needs to be adjusted
after running the model as it happens that there is not enough cropland
to allocate all the harvested area from the statistics, which suggests
that the cropping intensity is too low for some regions.</p>
<div class="section level3">
<h3 id="putting-the-subnational-statistics-in-the-right-format">Putting the subnational statistics in the right format<a class="anchor" aria-label="anchor" href="#putting-the-subnational-statistics-in-the-right-format"></a>
</h3>
<p>All crop statistics need to be stored in the <strong>wide</strong>
format. With this we mean that the first four columns of the data table
list the administrative unit code (<code>adm_code</code>), name
(<code>adm_name</code>), level (<code>adm_level</code>) and in case of
farming system shares or cropping intensity data, the farming system
(<code>system</code>), followed by named columns, one for each crop,
with harvested area, farming system shares or cropping intensity per
subnational unit. <code>adm_name</code> and <code>adm_code</code> must
be provided up to the most detailed administrative unit for which data
is available. Hence, in case level 2 data is available, data should be
supplied for level 0, 1 and 2. In case only level 1 data is available,
data should be supplied for level 0 and level 1.</p>
<p><code><a href="../reference/create_statistics_template.html">create_statistics_template()</a></code> will create templates for
the ha, fs and ci data files - also see the Malawi ha, fs and ci files
for examples. The number and depth of the administrative units will be
determined by the model parameters stored in the <code>spamc_par</code>
object as well as the <code>adm_list</code> file that is created with
<code><a href="../reference/create_adm_list.html">create_adm_list()</a></code>. By default, the template will have
columns for all 40 <code>mapspamc</code> crops.</p>
<p>You can save the template as csv file and use it as a basis to
prepare the statistics. Note that is is essential that you follow the
template closely! Adding or removing administrative units will result in
errors as the data no longer matches with the map that contains the
location of the administrative units. See below for more information how
to deal with missing crop information. In case of Malawi, most of the
data was already in the right format so we did not use the
templates.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create template for ha. Replace "ha" by "fs" or "ci" for other templates.</span></span>
<span><span class="co">#create_statistics_template("ha", param)</span></span></code></pre></div>
<p>For processing it is easier to transform the data into the
<strong>long</strong> format, which is similar to the <a href="https://tidyr.tidyverse.org/" class="external-link"><strong>tidy</strong> data
format</a> as implemented by the tidyverse packages. In our case this
means that the 40 crop columns are squeezed into two columns, one with
the crop code and another with the data. The <code>gather()</code> and
<code>spread()</code> in the <a href="https://tidyr.tidyverse.org/" class="external-link">tidyr</a> package were designed to
help you switch between wide and long tables.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> See below and the
Malawi scripts for examples.</p>
</div>
<div class="section level3">
<h3 id="aggregating-to-mapspamc-crop-classes">Aggregating to <code>mapspamc</code> crop classes<a class="anchor" aria-label="anchor" href="#aggregating-to-mapspamc-crop-classes"></a>
</h3>
<p>The raw statistics need to be mapped to the 40 crop and crop groups
used by <code>mapspamc</code>. The list of crops can be found in
<code>crop.csv</code>, which is automatically copied to the
<code>mappings</code> folder after running
<code>create_spam_folders()</code>. In practice, almost none of the
countries produces all 40 crops. To determine the set of relevant crops,
you can use the list of crops for which FAOSTAT presents data. Running
<code>01_process_faostat_crops.r</code> will save a
<code>faostat_crop_list.csv</code> file in the
<code>processed_data/lists folder</code>. Note that it is no problem to
keep all the 40 crops in your database as long as you set their values
to <code>NA</code> or <code>-999</code> (see below) so they are
automatically removed in the next processing step.</p>
<p>The easiest way to aggregate the raw subnational statistics to the
FAOSTAT crop list is to create an <code>orig2crop</code> mapping table,
which links the two crop lists. It might happen that the subnational
statistics contain crops that are not present in FAOSTAT. In these cases
you have to either exclude them or add them to one of the crops for
which FAOSTAT presents data.</p>
<p>The script below illustrates how to aggregate the raw statistics to
the <code>mapspamc</code> crops. Note that it important to use sum with
<code>na.rm = FALSE</code> as otherwise <code>NA+NA</code> will result
in <code>0</code> not <code>NA</code>. This is crucial as missing data
in the statistics need to be set to <code>NA</code> for
<code>mapspamc</code> in order to process them correctly. If data for
administrative units need to be aggregated a similar solution using a
mapping table can be applied.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NB: use sum with na.rm = F as we want NA+NA = NA, not NA+NA = 0!</span></span>
<span><span class="va">stat</span> <span class="op">&lt;-</span> <span class="va">stat</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">orig2crop</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">crop</span>, <span class="va">adm_code</span>, <span class="va">adm_name</span>, <span class="va">adm_level</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span>value_ha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value_ha</span>, na.rm <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="treatment-of-missing-data">Treatment of missing data<a class="anchor" aria-label="anchor" href="#treatment-of-missing-data"></a>
</h3>
<p>It is unlikely that you will find subnational statistics for all
relevant crops in a country. As a minimum requirement,
<code>mapspamc</code> needs full national level statistics for each
crop. This is generally no problem as harvested area statistics can be
taken from FAOSTAT. Farming system shares and cropping intensity data
might be more difficult to obtain and often require making strong
assumptions. At the subnational level, it is generally no problem to
have missing values for harvested area as data will be allocated to the
regions when the model is solved. Full information (harvest area
statistics, farming system shares and cropping intensity) is only needed
at administrative level 1 if the model is run at level 1 (solve level =
1) and never at administrative level 2.</p>
<p>In case data on harvested area is missing for a certain
administrative unit, you can indicate this by using <code>NA</code> or
<code>-999</code>. We highly recommend using the latter, particularly if
you are using Excel to process the data as it avoids potential errors
that may result between an <code>NA</code> and an empty string
<code>""</code> value. These are both displayed as empty cells in Excel
but will be treated differently by R after loading the file. Replacing
<code>NA</code> values by <code>-999</code> can be done simultaneously
when putting the data in the wide format.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Put in preferred mapspam format, adding -999 for missing values</span></span>
<span><span class="va">stat_mapspam</span> <span class="op">&lt;-</span> <span class="va">stat</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">spread</span><span class="op">(</span><span class="va">crop</span>, <span class="va">value_ha</span>, fill <span class="op">=</span> <span class="op">-</span><span class="fl">999</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">arrange</span><span class="op">(</span><span class="va">adm_code</span>, <span class="va">adm_code</span>, <span class="va">adm_level</span><span class="op">)</span> </span></code></pre></div>
<p>As pointed out above, it is safe to set all values for a crop to
<code>NA</code> or <code>-999</code> when the crop is not relevant for
the country. These will be filtered out in the script that is described
in the next section.</p>
</div>
<div class="section level3">
<h3 id="data-consistency">Data consistency<a class="anchor" aria-label="anchor" href="#data-consistency"></a>
</h3>
<p>Data should always be consistent and add up, meaning that the sum of
harvested area for all administrative units and a given crop is the same
or smaller (in case of missing information) as the corresponding higher
level unit. The script to check the statistics includes a function to
reaggregate the data from the bottom up and check for consistency. It is
however, essential that you check for consistency yourself when the data
is processed as otherwise a large bias might be introduced resulting in
completely erroneous data and model output. For example, suppose there
is error in the raw harvested area statistics for maize for a certain
administrative level 2 region. As a result the sum of harvested maize
area of all level 2 units is much higher than the maize area of the
corresponding level 1 unit, which is a clear inconsistency. The function
that reaggregates the statistics will simply take the level 2 total for
maize and substitute the level 1 maize data. This error is subsequently
carried forward when the maize area for all level 1 unit are aggregated
to the national total. The final data table will include maize data that
is strongly biased upwards.</p>
</div>
</div>
<div class="section level2">
<h2 id="check-and-calibrate-subnational-statistics">Check and calibrate subnational statistics<a class="anchor" aria-label="anchor" href="#check-and-calibrate-subnational-statistics"></a>
</h2>
<p>After most hard work is done, the ha, fs and cs files need to be
checked for consistency and calibrated to the FAOSTAT national
statistics. This is done in
<code>03_check_and_calibrate_statistics.r</code>. The first step is to
check if the data is consistent, which is done by
<code><a href="../reference/check_statistics.html">check_statistics()</a></code>. If <code>out = TRUE</code> is set a
report is returned which shows where the inconsistencies occur.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check the consistency of the ha statistics</span></span>
<span><span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span><span class="op">(</span><span class="va">ha_df</span>, <span class="va">param</span>, out <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>To reaggreate the statistics from the bottom up, use
<code><a href="../reference/reaggregate_statistics.html">reaggregate_statistics()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reaggreate from the bottom up.</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reaggregate_statistics.html">reaggregate_statistics</a></span><span class="op">(</span><span class="va">ha_df</span>, <span class="va">param</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check again.</span></span>
<span><span class="fu"><a href="../reference/check_statistics.html">check_statistics</a></span><span class="op">(</span><span class="va">ha_df</span>, <span class="va">param</span>, out <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>Next, the statistics are calibrated to the national FAOSTAT
statistics. The code below shows how this is implemented. First, the
code checks if there are still crops included which are not in the
FAOSTAT data and removes them if needed. Next, crops are identified that
are not present in the statisitics and the national total is added from
the FAOSTAT database. Finally all the subnational statistics are
proportionally scaled so the total is equal to the FAOSTAT figures.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify crops that are present in ha_df but not in fao and remove them from ha_df.</span></span>
<span><span class="va">crop_rem</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">fao</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">crop</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">crop_rem</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify crops that are present in fao but not in ha_df.</span></span>
<span><span class="co"># We will add then to ha_df</span></span>
<span><span class="va">crop_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">fao</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">crop</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>    <span class="va">fao</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">crop</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">crop_add</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>      <span class="fu">mutate</span><span class="op">(</span></span>
<span>        fips <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_code</span><span class="op">[</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_level</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        adm_level <span class="op">=</span> <span class="fl">0</span>,</span>
<span>        adm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_name</span><span class="op">[</span><span class="va">ha_df</span><span class="op">$</span><span class="va">adm_level</span><span class="op">==</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate scaling factor</span></span>
<span><span class="va">fao_stat_sf</span> <span class="op">&lt;-</span><span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="va">fao</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>source <span class="op">=</span> <span class="st">"fao"</span><span class="op">)</span>,</span>
<span>  <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adm_level</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>source <span class="op">=</span> <span class="st">"ha_df"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">crop</span>, <span class="va">source</span>, <span class="va">ha</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">spread</span><span class="op">(</span><span class="va">source</span>, <span class="va">ha</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>sf <span class="op">=</span> <span class="va">fao</span><span class="op">/</span><span class="va">ha_df</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">crop</span>, <span class="va">sf</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># rescale ha_df</span></span>
<span><span class="va">ha_df</span> <span class="op">&lt;-</span> <span class="va">ha_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">fao_stat_sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>ha <span class="op">=</span> <span class="va">ha</span> <span class="op">*</span> <span class="va">sf</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">sf</span><span class="op">)</span></span></code></pre></div>
<p>Finally the three files (ha, fs and ci), need to be saved in the
`processed_data/agricultural_statistics folders. It is important to use
the correct names otherwise other functions cannot find the data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ha_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/ha_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">write_csv</span><span class="op">(</span><span class="va">fs_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/fs_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ci_df</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">param</span><span class="op">$</span><span class="va">mapspamc_path</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"processed_data/agricultural_statistics/ci_adm_{param$year}_{param$iso3c}.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The next step is to <a href="process_spatial_data.html">process the
spatial data</a>.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>Note that these functions have recently been replaced by
<code>pivot_long()</code> and <code>pivot_wide()</code>. In a next
update we will use these as well.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michiel Van Dijk.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
